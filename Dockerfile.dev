FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# System dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    vim \
    unzip \
    htop \
    software-properties-common \
    bash \
    ca-certificates \
    python3 \
    python3-venv \
    python3-dev \
    gcc \
    g++ \
    gfortran \
    make \
    libopenblas-dev \
    liblapack-dev \
    libffi-dev \
    libssl-dev \
    build-essential \
    && apt-get clean

ENV CHROME_VERSION=138.0.7204.168
ENV CHROME_DIR=/opt/chrome
ENV CHROMEDRIVER_DIR=/opt/chromedriver
ENV PATH="${CHROME_DIR}:${CHROMEDRIVER_DIR}:${PATH}"

RUN mkdir -p $CHROME_DIR \
    && wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chrome-linux64.zip" \
    && unzip chrome-linux64.zip -d $CHROME_DIR \
    && rm chrome-linux64.zip \
    && mv $CHROME_DIR/chrome-linux64/* $CHROME_DIR/ \
    && rm -rf $CHROME_DIR/chrome-linux64

RUN mkdir -p $CHROMEDRIVER_DIR \
    && wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chromedriver-linux64.zip" \
    && unzip chromedriver-linux64.zip -d $CHROMEDRIVER_DIR \
    && rm chromedriver-linux64.zip \
    && mv $CHROMEDRIVER_DIR/chromedriver-linux64/chromedriver $CHROMEDRIVER_DIR/ \
    && rm -rf $CHROMEDRIVER_DIR/chromedriver-linux64 \
    && chmod +x $CHROMEDRIVER_DIR/chromedriver

RUN ln -s $CHROME_DIR/chrome $CHROME_DIR/google-chrome || true

RUN curl -LsSf https://astral.sh/uv/install.sh | sh 
ENV PATH="/root/.local/bin:$PATH"

RUN which uv && uv --version

WORKDIR /app
COPY requirements.txt .

RUN uv venv /venv
ENV PATH="/venv/bin:$PATH"

RUN uv pip install --no-cache-dir --force-reinstall numpy
RUN uv pip install --no-cache-dir --force-reinstall -r requirements.txt

COPY . .

CMD ["bash"]
